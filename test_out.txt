============================= test session starts ==============================
platform darwin -- Python 3.10.7, pytest-7.2.0, pluggy-1.0.0 -- /Users/cjy/eecs485/p4-mapreduce/env/bin/python3.10
cachedir: .pytest_cache
rootdir: /Users/cjy/eecs485/p4-mapreduce
plugins: mock-3.10.0
collecting ... collected 1 item

tests/test_manager_03.py::test_finish 
-------------------------------- live log call ---------------------------------
INFO     mapreduce.manager.__main__:__main__.py:64 Starting manager host=localhost port=6000 pwd=/Users/cjy/eecs485/p4-mapreduce
INFO     mapreduce.manager.__main__:__main__.py:282 Created tmpdir /private/var/folders/h0/htpjtrh57z53gn45nkqhfp2c0000gn/T/pytest-of-cjy/pytest-44/test_finish0/mapreduce-shared-job00000-25ts4a8r
INFO     mapreduce.manager.__main__:__main__.py:290 Cleaned up tmpdir /private/var/folders/h0/htpjtrh57z53gn45nkqhfp2c0000gn/T/pytest-of-cjy/pytest-44/test_finish0/mapreduce-shared-job00000-25ts4a8r
FAILED

=================================== FAILURES ===================================
_________________________________ test_finish __________________________________

mocker = <pytest_mock.plugin.MockerFixture object at 0x10c8461a0>
tmp_path = PosixPath('/private/var/folders/h0/htpjtrh57z53gn45nkqhfp2c0000gn/T/pytest-of-cjy/pytest-44/test_finish0')

    def test_finish(mocker, tmp_path):
        """Verify Manager finishes job correctly.
    
        Note: 'mocker' is a fixture function provided the the pytest-mock package.
        This fixture lets us override a library function with a temporary fake
        function that returns a hardcoded value while testing.
    
        See https://github.com/pytest-dev/pytest-mock/ for more info.
    
        Note: 'tmp_path' is a fixture provided by the pytest-mock package.
        This fixture creates a temporary directory for use within this test.
    
        See https://docs.pytest.org/en/6.2.x/tmpdir.html for more info.
        """
        # Mock the socket library socket class
        mock_socket = mocker.patch("socket.socket")
    
        # sendall() records messages
        mock_sendall = mock_socket.return_value.__enter__.return_value.sendall
    
        # accept() returns a mock client socket
        mock_clientsocket = mocker.MagicMock()
        mock_accept = mock_socket.return_value.__enter__.return_value.accept
        mock_accept.return_value = (mock_clientsocket, ("127.0.0.1", 10000))
    
        # TCP recv() returns values generated by worker_message_generator()
        mock_recv = mock_clientsocket.recv
        mock_recv.side_effect = worker_message_generator(mock_sendall, tmp_path)
    
        # UDP recv() returns heartbeat messages
        mock_udp_recv = mock_socket.return_value.__enter__.return_value.recv
        mock_udp_recv.side_effect = utils.worker_heartbeat_generator(3001)
    
        # Set the location where the Manager's temporary directory
        # will be created.
        tempfile.tempdir = tmp_path
    
        # Spy on tempfile.TemporaryDirectory so that we can determine the name
        # of the directory that was created.
        mock_tmpdir = mocker.spy(tempfile.TemporaryDirectory, "__init__")
    
        # Run student Manager code.  When student Manager calls recv(), it will
        # return the faked responses configured above.
        try:
            mapreduce.manager.Manager("localhost", 6000)
            utils.wait_for_threads()
        except SystemExit as error:
            assert error.code == 0
    
        # Verify that the correct number of TemporaryDirectories was used.
        assert mock_tmpdir.call_count == 1, \
            "Expected to see call to `tempfile.TemporaryDirectory(...)`"
    
        # Find the name of the temporary directory.
        tmpdir_job0 = utils.get_tmpdir_name(mock_tmpdir)
    
        # Verify messages sent by the Manager
        #
        # Pro-tip: show log messages and detailed diffs with
        #   $ pytest -vvs --log-cli-level=info tests/test_manager_X.py
        messages = utils.get_messages(mock_sendall)
>       assert messages == [
            {
                "message_type": "register_ack",
                "worker_host": "localhost",
                "worker_port": 3001,
            },
            {
                "message_type": "new_map_task",
                "task_id": 0,
                "executable": str(TESTDATA_DIR/"exec/wc_map.sh"),
                "input_paths": [
                    str(TESTDATA_DIR/"input/file01"),
                    str(TESTDATA_DIR/"input/file03"),
                    str(TESTDATA_DIR/"input/file05"),
                    str(TESTDATA_DIR/"input/file07"),
                ],
                "output_directory": tmpdir_job0,
                "num_partitions": 1,
                "worker_host": "localhost",
                "worker_port": 3001,
            },
            {
                "message_type": "new_map_task",
                "task_id": 1,
                "executable": str(TESTDATA_DIR/"exec/wc_map.sh"),
                "input_paths": [
                    str(TESTDATA_DIR/"input/file02"),
                    str(TESTDATA_DIR/"input/file04"),
                    str(TESTDATA_DIR/"input/file06"),
                    str(TESTDATA_DIR/"input/file08"),
                ],
                "output_directory": tmpdir_job0,
                "num_partitions": 1,
                "worker_host": "localhost",
                "worker_port": 3001,
            },
            {
                "message_type": "new_reduce_task",
                "task_id": 0,
                "executable": str(TESTDATA_DIR/"exec/wc_reduce.sh"),
                "input_paths": [
                    f"{tmpdir_job0}/maptask00000-part00000",
                    f"{tmpdir_job0}/maptask00001-part00000"
                ],
                "output_directory": str(tmp_path),
                "worker_host": "localhost",
                "worker_port": 3001,
            },
            {
                "message_type": "shutdown",
            },
        ]
E       AssertionError: assert [{'message_type': 'register_ack', 'worker_host': 'localhost', 'worker_port': 3001}, {'message_type': 'new_map_task', 'task_id': 0, 'input_paths': ['/Users/cjy/eecs485/p4-mapreduce/tests/testdata/input/file01', '/Users/cjy/eecs485/p4-mapreduce/tests/testdata/input/file03', '/Users/cjy/eecs485/p4-mapreduce/tests/testdata/input/file05', '/Users/cjy/eecs485/p4-mapreduce/tests/testdata/input/file07'], 'executable': '/Users/cjy/eecs485/p4-mapreduce/tests/testdata/exec/wc_map.sh', 'output_directory': '/private/var/folders/h0/htpjtrh57z53gn45nkqhfp2c0000gn/T/pytest-of-cjy/pytest-44/test_finish0/mapreduce-shared-job00000-25ts4a8r', 'num_partitions': 1, 'worker_host': 'localhost', 'worker_port': 3001}, {'message_type': 'new_map_task', 'task_id': 1, 'input_paths': ['/Users/cjy/eecs485/p4-mapreduce/tests/testdata/input/file02', '/Users/cjy/eecs485/p4-mapreduce/tests/testdata/input/file04', '/Users/cjy/eecs485/p4-mapreduce/tests/testdata/input/file06', '/Users/cjy/eecs485/p4-mapreduce/tests/testdata/input/file08'], 'executable': '/Users/cjy/eecs485/p4-mapreduce/tests/testdata/exec/wc_map.sh', 'output_directory': '/private/var/folders/h0/htpjtrh57z53gn45nkqhfp2c0000gn/T/pytest-of-cjy/pytest-44/test_finish0/mapreduce-shared-job00000-25ts4a8r', 'num_partitions': 1, 'worker_host': 'localhost', 'worker_port': 3001}, {'message_type': 'new_reduce_task', 'task_id': 0, 'executable': '/Users/cjy/eecs485/p4-mapreduce/tests/testdata/exec/wc_reduce.sh', 'input_paths': ['/private/var/folders/h0/htpjtrh57z53gn45nkqhfp2c0000gn/T/pytest-of-cjy/pytest-44/test_finish0/mapreduce-shared-job00000-25ts4a8r/maptask00001-part00000', '/private/var/folders/h0/htpjtrh57z53gn45nkqhfp2c0000gn/T/pytest-of-cjy/pytest-44/test_finish0/mapreduce-shared-job00000-25ts4a8r/maptask00000-part00000'], 'output_directory': '/private/var/folders/h0/htpjtrh57z53gn45nkqhfp2c0000gn/T/pytest-of-cjy/pytest-44/test_finish0', 'worker_host': 'localhost', 'worker_port': 3001}, {'message_type': 'shutdown'}] == [{'message_type': 'register_ack', 'worker_host': 'localhost', 'worker_port': 3001}, {'message_type': 'new_map_task', 'task_id': 0, 'executable': '/Users/cjy/eecs485/p4-mapreduce/tests/testdata/exec/wc_map.sh', 'input_paths': ['/Users/cjy/eecs485/p4-mapreduce/tests/testdata/input/file01', '/Users/cjy/eecs485/p4-mapreduce/tests/testdata/input/file03', '/Users/cjy/eecs485/p4-mapreduce/tests/testdata/input/file05', '/Users/cjy/eecs485/p4-mapreduce/tests/testdata/input/file07'], 'output_directory': '/private/var/folders/h0/htpjtrh57z53gn45nkqhfp2c0000gn/T/pytest-of-cjy/pytest-44/test_finish0/mapreduce-shared-job00000-25ts4a8r', 'num_partitions': 1, 'worker_host': 'localhost', 'worker_port': 3001}, {'message_type': 'new_map_task', 'task_id': 1, 'executable': '/Users/cjy/eecs485/p4-mapreduce/tests/testdata/exec/wc_map.sh', 'input_paths': ['/Users/cjy/eecs485/p4-mapreduce/tests/testdata/input/file02', '/Users/cjy/eecs485/p4-mapreduce/tests/testdata/input/file04', '/Users/cjy/eecs485/p4-mapreduce/tests/testdata/input/file06', '/Users/cjy/eecs485/p4-mapreduce/tests/testdata/input/file08'], 'output_directory': '/private/var/folders/h0/htpjtrh57z53gn45nkqhfp2c0000gn/T/pytest-of-cjy/pytest-44/test_finish0/mapreduce-shared-job00000-25ts4a8r', 'num_partitions': 1, 'worker_host': 'localhost', 'worker_port': 3001}, {'message_type': 'new_reduce_task', 'task_id': 0, 'executable': '/Users/cjy/eecs485/p4-mapreduce/tests/testdata/exec/wc_reduce.sh', 'input_paths': ['/private/var/folders/h0/htpjtrh57z53gn45nkqhfp2c0000gn/T/pytest-of-cjy/pytest-44/test_finish0/mapreduce-shared-job00000-25ts4a8r/maptask00000-part00000', '/private/var/folders/h0/htpjtrh57z53gn45nkqhfp2c0000gn/T/pytest-of-cjy/pytest-44/test_finish0/mapreduce-shared-job00000-25ts4a8r/maptask00001-part00000'], 'output_directory': '/private/var/folders/h0/htpjtrh57z53gn45nkqhfp2c0000gn/T/pytest-of-cjy/pytest-44/test_finish0', 'worker_host': 'localhost', 'worker_port': 3001}, {'message_type': 'shutdown'}]
E         At index 3 diff: {'message_type': 'new_reduce_task', 'task_id': 0, 'executable': '/Users/cjy/eecs485/p4-mapreduce/tests/testdata/exec/wc_reduce.sh', 'input_paths': ['/private/var/folders/h0/htpjtrh57z53gn45nkqhfp2c0000gn/T/pytest-of-cjy/pytest-44/test_finish0/mapreduce-shared-job00000-25ts4a8r/maptask00001-part00000', '/private/var/folders/h0/htpjtrh57z53gn45nkqhfp2c0000gn/T/pytest-of-cjy/pytest-44/test_finish0/mapreduce-shared-job00000-25ts4a8r/maptask00000-part00000'], 'output_directory': '/private/var/folders/h0/htpjtrh57z53gn45nkqhfp2c0000gn/T/pytest-of-cjy/pytest-44/test_finish0', 'worker_host': 'localhost', 'worker_port': 3001} != {'message_type': 'new_reduce_task', 'task_id': 0, 'executable': '/Users/cjy/eecs485/p4-mapreduce/tests/testdata/exec/wc_reduce.sh', 'input_paths': ['/private/var/folders/h0/htpjtrh57z53gn45nkqhfp2c0000gn/T/pytest-of-cjy/pytest-44/test_finish0/mapreduce-shared-job00000-25ts4a8r/maptask00000-part00000', '/private/var/folders/h0/htpjtrh57z53gn45nkqhfp2c0000gn/T/pytest-of-cjy/pytest-44/test_finish0/mapreduce-shared-job00000-25ts4a8r/maptask00001-part00000'], 'output_directory': '/private/var/folders/h0/htpjtrh57z53gn45nkqhfp2c0000gn/T/pytest-of-cjy/pytest-44/test_finish0', 'worker_host': 'localhost', 'worker_port': 3001}
E         Full diff:
E           [
E            {'message_type': 'register_ack',
E             'worker_host': 'localhost',
E             'worker_port': 3001},
E            {'executable': '/Users/cjy/eecs485/p4-mapreduce/tests/testdata/exec/wc_map.sh',
E             'input_paths': ['/Users/cjy/eecs485/p4-mapreduce/tests/testdata/input/file01',
E                             '/Users/cjy/eecs485/p4-mapreduce/tests/testdata/input/file03',
E                             '/Users/cjy/eecs485/p4-mapreduce/tests/testdata/input/file05',
E                             '/Users/cjy/eecs485/p4-mapreduce/tests/testdata/input/file07'],
E             'message_type': 'new_map_task',
E             'num_partitions': 1,
E             'output_directory': '/private/var/folders/h0/htpjtrh57z53gn45nkqhfp2c0000gn/T/pytest-of-cjy/pytest-44/test_finish0/mapreduce-shared-job00000-25ts4a8r',
E             'task_id': 0,
E             'worker_host': 'localhost',
E             'worker_port': 3001},
E            {'executable': '/Users/cjy/eecs485/p4-mapreduce/tests/testdata/exec/wc_map.sh',
E             'input_paths': ['/Users/cjy/eecs485/p4-mapreduce/tests/testdata/input/file02',
E                             '/Users/cjy/eecs485/p4-mapreduce/tests/testdata/input/file04',
E                             '/Users/cjy/eecs485/p4-mapreduce/tests/testdata/input/file06',
E                             '/Users/cjy/eecs485/p4-mapreduce/tests/testdata/input/file08'],
E             'message_type': 'new_map_task',
E             'num_partitions': 1,
E             'output_directory': '/private/var/folders/h0/htpjtrh57z53gn45nkqhfp2c0000gn/T/pytest-of-cjy/pytest-44/test_finish0/mapreduce-shared-job00000-25ts4a8r',
E             'task_id': 1,
E             'worker_host': 'localhost',
E             'worker_port': 3001},
E            {'executable': '/Users/cjy/eecs485/p4-mapreduce/tests/testdata/exec/wc_reduce.sh',
E         -   'input_paths': ['/private/var/folders/h0/htpjtrh57z53gn45nkqhfp2c0000gn/T/pytest-of-cjy/pytest-44/test_finish0/mapreduce-shared-job00000-25ts4a8r/maptask00000-part00000',
E         ?                                                                                                                                                                ^
E         +   'input_paths': ['/private/var/folders/h0/htpjtrh57z53gn45nkqhfp2c0000gn/T/pytest-of-cjy/pytest-44/test_finish0/mapreduce-shared-job00000-25ts4a8r/maptask00001-part00000',
E         ?                                                                                                                                                                ^
E         -                   '/private/var/folders/h0/htpjtrh57z53gn45nkqhfp2c0000gn/T/pytest-of-cjy/pytest-44/test_finish0/mapreduce-shared-job00000-25ts4a8r/maptask00001-part00000'],
E         ?                                                                                                                                                                ^
E         +                   '/private/var/folders/h0/htpjtrh57z53gn45nkqhfp2c0000gn/T/pytest-of-cjy/pytest-44/test_finish0/mapreduce-shared-job00000-25ts4a8r/maptask00000-part00000'],
E         ?                                                                                                                                                                ^
E             'message_type': 'new_reduce_task',
E             'output_directory': '/private/var/folders/h0/htpjtrh57z53gn45nkqhfp2c0000gn/T/pytest-of-cjy/pytest-44/test_finish0',
E             'task_id': 0,
E             'worker_host': 'localhost',
E             'worker_port': 3001},
E            {'message_type': 'shutdown'},
E           ]

tests/test_manager_03.py:166: AssertionError
------------------------------ Captured log call -------------------------------
INFO     mapreduce.manager.__main__:__main__.py:64 Starting manager host=localhost port=6000 pwd=/Users/cjy/eecs485/p4-mapreduce
INFO     mapreduce.manager.__main__:__main__.py:282 Created tmpdir /private/var/folders/h0/htpjtrh57z53gn45nkqhfp2c0000gn/T/pytest-of-cjy/pytest-44/test_finish0/mapreduce-shared-job00000-25ts4a8r
INFO     mapreduce.manager.__main__:__main__.py:290 Cleaned up tmpdir /private/var/folders/h0/htpjtrh57z53gn45nkqhfp2c0000gn/T/pytest-of-cjy/pytest-44/test_finish0/mapreduce-shared-job00000-25ts4a8r
=========================== short test summary info ============================
FAILED tests/test_manager_03.py::test_finish - AssertionError: assert [{'mess...
!!!!!!!!!!!!!!!!!!!!!!!!!! stopping after 1 failures !!!!!!!!!!!!!!!!!!!!!!!!!!!
============================== 1 failed in 4.08s ===============================
